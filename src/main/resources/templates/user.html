<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Bookly - Trang Qu·∫£n l√Ω T√†i kho·∫£n</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-y3qzM..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/admin-product-list.css}">
    <style>
        :root{
            --primary: #F86D72;
            --accent: #FFB4A2;
            --muted: #6c757d;
            --card-bg: #ffffff;
        }
        body{
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(180deg, #fff 0%, #f7f7f9 100%);
            margin:0;
            min-height:100vh;
        }

        /* Header */
        header.site-header{
            background: linear-gradient(90deg,
                #343A40 0%, /* M√†u x√°m ƒë·∫≠m */
                #6C757D 15%, /* Chuy·ªÉn d·∫ßn sang x√°m nh·∫°t */
                #E6E6FA 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        header .brand { font-weight:600; letter-spacing: .3px; }

        /* Custom CSS cho n√∫t Gi·ªè h√†ng v√† ƒêƒÉng xu·∫•t (Ch·ªØ m·ªôt d√≤ng) */
        .button-group-header {
            gap: 8px; /* Kho·∫£ng c√°ch gi·ªØa 2 n√∫t */
        }

        .header-action-btn {
            display: flex;
            justify-content: center;
            align-items: center;

            /* K√≠ch th∆∞·ªõc m·ªõi ph√π h·ª£p v·ªõi n·ªôi dung 1 d√≤ng */
            width: auto; /* Chi·ªÅu r·ªông t·ª± ƒë·ªông co gi√£n theo n·ªôi dung */
            min-width: 80px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu */
            height: 40px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh */
            padding: 0 16px; /* Padding ngang ƒë·ªÉ n√∫t r·ªông ra */

            /* Thi·∫øt k·∫ø chung */
            border-radius: 12px; /* Bo tr√≤n l·ªõn */
            font-weight: 500;
            font-size: 14px;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            color: white !important; /* Ch·ªØ m√†u tr·∫Øng */
            border: none;
        }

        /* √Åp d·ª•ng m·ªôt m√†u xanh ƒë·ªìng nh·∫•t v·ªõi ƒë·ªô trong su·ªët */
        .header-action-btn.single-color-btn {
            /* M√†u xanh d∆∞∆°ng nh·∫π v√† trong su·ªët h∆°n cho Gi·ªè h√†ng */
            background-color: rgba(59, 113, 202, 0.6);
        }

        .header-action-btn.primary-color-btn {
            /* M√†u xanh d∆∞∆°ng ƒë·∫≠m h∆°n v√† √≠t trong su·ªët h∆°n cho ƒêƒÉng xu·∫•t */
            background-color: rgba(59, 113, 202, 0.85);
        }

        /* Hi·ªáu ·ª©ng Hover */
        .header-action-btn:hover {
            opacity: 1; /* TƒÉng ƒë·ªô ƒë·∫≠m khi hover */
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        /* Layout */
        .layout {
            display: flex;
            gap: 20px;
            padding: 24px;
            align-items: stretch;
        }
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg,var(--primary), #e85a58);
            color: white;
            border-radius: 12px;
            padding: 18px;
            flex-shrink: 0;
            height: calc(100vh - 120px);
            position: sticky;
            top: 72px;
            overflow-y: auto;
        }
        .sidebar .user-mini {
            display:flex; gap:12px; align-items:center; margin-bottom: 14px;
        }
        .user-avatar {
            width:56px; height:56px; border-radius:50%;
            object-fit:cover; border:2px solid rgba(255,255,255,0.6);
        }
        .nav-link-dashboard {
            display:flex; justify-content:space-between; align-items:center;
            color:white; padding:10px 12px; border-radius:8px; margin-bottom:8px;
            text-decoration:none;
        }
        .nav-link-dashboard:hover {
            background: rgba(255,255,255);
            text-decoration:none;
        }
        .nav-link-dashboard.active{
            background: rgba(240, 144, 143);
        }
        .main {
            flex:1;
            min-height: calc(100vh - 120px);
            overflow:auto;
            padding-bottom: 40px;
        }

        /* Cards */
        .card-dash {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(18,38,63,0.04);
            border: none;
            background: var(--card-bg);
        }

        .card-dash .text-muted.small {
            color: #c7309f !important;
            font-weight: 900; /* C√≥ th·ªÉ tƒÉng ƒë·ªô ƒë·∫≠m n·∫øu c·∫ßn */
        }

        .text-muted.small {
            color: #c7309f !important;
            font-weight: 900; /* C√≥ th·ªÉ tƒÉng ƒë·ªô ƒë·∫≠m n·∫øu c·∫ßn */
        }

        .text-muted {
            color: #c7309f !important;
            font-weight: 600; /* C√≥ th·ªÉ tƒÉng ƒë·ªô ƒë·∫≠m n·∫øu c·∫ßn */
        }

        /* Product box equal height */
        .product-card .card-body { display:flex; flex-direction:column; justify-content:space-between; }

        /* Footer */
        footer.site-footer{
            padding: 18px 24px;
            background: #fafafa;
            color: var(--muted);
            border-top: 1px solid #eee;
            text-align:center;
        }

        /* Responsive */
        @media (max-width: 991px) {
            .layout { padding: 12px; flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: relative; top: 0; }
            .main { min-height: auto; }
        }

        /* T√πy ch·ªânh CSS cho Modal (ƒê√£ thu nh·ªè) */
        .modal-body {
            /* Gi·ªØ nguy√™n max-height 70vh ƒë·ªÉ ƒë·∫£m b·∫£o cu·ªôn n·∫øu c·∫ßn */
            max-height: 70vh;
            overflow-y: auto;
        }
        /* Lo·∫°i b·ªè g-3 n·∫øu b·∫°n mu·ªën thu h·∫πp kho·∫£ng c√°ch gi·ªØa c√°c tr∆∞·ªùng trong Modal */
        /* T√¥i s·∫Ω gi·ªØ nguy√™n g-3 trong code HTML v√¨ n√≥ l√† default gap c·ªßa Bootstrap */
    </style>
</head>
<body>

<header class="site-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
        <a class="navbar-brand" th:href="@{/home}">
            <img th:src="@{/images/main-logo.png}" class="logo">
        </a>
        <span class="text-white-50 small">‚Äî Trang qu·∫£n l√Ω t√†i kho·∫£n</span>
    </div>

    <div class="d-flex align-items-center button-group-header">
        <a th:href="@{/user/logout}" class="header-action-btn single-color-btn primary-color-btn">ƒêƒÉng xu·∫•t</a>
    </div>
</header>

<div class="layout container-fluid">
    <aside class="sidebar" aria-label="Sidebar">
        <div class="user-mini">
            <img th:src="@{'/user/avatar/' + ${session.loggedInUser.id}}" onerror="this.src='/images/default-avatar.png'" class="user-avatar" alt="avatar"/>
            <div>
                <div style="font-weight:600" th:text="${session.loggedInUser.firstName + ' ' + session.loggedInUser.lastName}">User Name</div>
                <div class="small text-white-50" th:text="${session.loggedInUser.role}">USER</div>
            </div>
        </div>

        <div th:if="${session.loggedInUser.role == 'USER'}">
            <a href="#" data-target="profile" class="nav-link-dashboard active" onclick="switchTab(event)">
                <div><i class="fa-solid fa-user me-2"></i>Th√¥ng tin c√° nh√¢n</div>
            </a>
            <a href="#" data-target="cart" class="nav-link-dashboard" onclick="switchTab(event)">
                <div><i class="fa-solid fa-cart-shopping me-2"></i>Gi·ªè h√†ng</div>
            </a>
            <a href="#" data-target="orders" class="nav-link-dashboard" onclick="switchTab(event)">
                <div><i class="fa-solid fa-boxes-stacked me-2"></i>L·ªãch s·ª≠ mua h√†ng</div>
            </a>
        </div>

        <div th:if="${session.loggedInUser.role == 'ADMIN'}">
            <a href="#" data-target="profile" class="nav-link-dashboard active" onclick="switchTab(event)">
                <div><i class="fa-solid fa-user-gear me-2"></i>Th√¥ng tin c√° nh√¢n</div>
            </a>
            <a href="#" data-target="admin-users" class="nav-link-dashboard" onclick="switchTab(event)">
                <div><i class="fa-solid fa-users me-2"></i>User</div>
            </a>
            <a href="#" data-target="admin-categories" class="nav-link-dashboard" onclick="switchTab(event)">
                <div><i class="fa-solid fa-tags me-2"></i>Th·ªÉ lo·∫°i</div>
            </a>
            <a href="#" data-target="admin-products" class="nav-link-dashboard" onclick="switchTab(event)">
                <div><i class="fa-solid fa-book me-2"></i>S·∫£n ph·∫©m</div>
            </a>
            <a href="#" data-target="admin-orders" class="nav-link-dashboard" onclick="switchTab(event)">
                <div><i class="fa-solid fa-truck-fast me-2"></i>Qu·∫£n l√Ω ƒê∆°n h√†ng</div>
            </a>
            <a href="#" data-target="admin-overview" class="nav-link-dashboard " onclick="switchTab(event)">
                <div><i class="fa-solid fa-gauge-high me-2"></i>Doanh thu</div>
            </a>
        </div>
    </aside>

    <main class="main">
<!--Th√¥ng tin c√° nh√¢n USER/ADMIN-->
        <section id="profile" class="tab-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Th√¥ng tin c√° nh√¢n</h3>
            </div>
            <div class="card card-dash p-4 mb-4">
                <div class="row g-4">
                    <div class="col-md-4 text-center">
                        <img th:src="@{'/user/avatar/' + ${session.loggedInUser.id}}" onerror="this.src='/images/default-avatar.png'"
                             class="rounded-circle mb-3" style="width:140px;height:140px;object-fit:cover;border:5px solid var(--primary)"/>
                        <form th:action="@{/user/update}" method="post" enctype="multipart/form-data">
                            <input type="file" name="imageFile" class="form-control form-control-sm mb-2" accept="image/*"/>
                            <div class="form-group row">
                                <label for="lastName" class="col-sm-3 col-form-label">H·ªç:</label>
                                <div class="col-sm-9">
                                    <input type="text" id="lastName" name="lastName" th:value="${session.loggedInUser.lastName}" class="form-control form-control-sm" placeholder="H·ªç">
                                </div>
                            </div>

                            <div class="form-group row">
                                <label for="firstName" class="col-sm-3 col-form-label">T√™n:</label>
                                <div class="col-sm-9">
                                    <input type="text" id="firstName" name="firstName" th:value="${session.loggedInUser.firstName}" class="form-control form-control-sm" placeholder="T√™n">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary w-100">C·∫≠p nh·∫≠t th√¥ng tin</button>
                        </form>
                    </div>

                    <div class="col-md-8">
                        <h5>Chi ti·∫øt t√†i kho·∫£n</h5>
                        <table class="table table-borderless mt-3">
                            <tr><th class="w-25">Email</th><td th:text="${session.loggedInUser.email}">user@example.com</td></tr>
                            <tr><th>Vai tr√≤</th><td th:text="${session.loggedInUser.role}">USER</td></tr>
                            <tr><th>Tr·∫°ng th√°i</th><td th:text="${session.loggedInUser.enabled ? 'ƒêang ho·∫°t ƒë·ªông' : 'B·ªã kh√≥a'}">ƒêang ho·∫°t ƒë·ªông</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </section>
<!--Gi·ªè h√†ng USER-->
        <section id="cart" class="tab-section" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Gi·ªè h√†ng</h3>
            </div>
            <div th:replace="fragments/cart-product :: cartProductList(cartItems=${cartItems}, total=${total})"></div>
        </section>
<!--ƒê∆°n h√†ng USER-->
        <section id="orders" class="tab-section" style="display:none" th:if="${session.loggedInUser.role == 'USER'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>ƒê∆°n h√†ng c·ªßa t√¥i</h3>
            </div>
            <div th:replace="fragments/order :: orderList(orders=${orders})"></div>
        </section>
<!--T·ªïng quan ADMIN-->
        <section id="admin-overview" class="tab-section" style="display:none" th:if="${session.loggedInUser.role == 'ADMIN'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>T·ªïng quan (Admin)</h3>
            </div>

            <div class="mb-4">
                <h2 class="mb-4 text-primary"><i class="bi bi-graph-up me-2"></i> T·ªïng Quan (Admin)</h2>
                <hr/>
            </div>

            <!-- Fragment 1: Doanh thu & Bi·ªÉu ƒë·ªì -->
            <div th:replace="fragments/admin-analysis-sell :: analysisSellView(
                todayRevenue=${todayRevenue},
                monthRevenue=${monthRevenue},
                yearRevenue=${yearRevenue},
                monthlyRevenue=${monthlyRevenue})">
            </div>

            <!-- Fragment 2: Best Sellers -->
            <div th:replace="fragments/admin-analysis-book :: analysisBookView(
                bestSellers=${bestSellers})">
            </div>
        </section>
<!--Qu·∫£n l√Ω user ADMIN-->
        <section id="admin-users" class="tab-section" style="display:none" th:if="${session.loggedInUser.role == 'ADMIN'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Qu·∫£n l√Ω User</h3>
            </div>

            <div class="card card-dash p-3 mb-3">
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>H·ªç</th>
                        <th>T√™n</th>
                        <th>Email</th>
                        <th>Vai tr√≤</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="u : ${allUsers}">
                        <td th:text="${u.id}"></td>
                        <td th:text="${u.lastName}"></td>
                        <td th:text="${u.firstName}"></td>
                        <td th:text="${u.email}"></td>

                        <td>
                            <form th:action="@{/user/admin/users/role}" method="post" th:id="'form-role-' + ${u.id}">
                                <input type="hidden" name="userId" th:value="${u.id}">
                                <select name="role" class="form-select form-select-sm" style="width:100px;">
                                    <option th:selected="${u.role=='USER'}">USER</option>
                                    <option th:selected="${u.role=='ADMIN'}">ADMIN</option>
                                </select>
                        </td>

                        <td><span class="badge" th:classappend="${u.enabled} ? 'bg-success' : 'bg-danger'" th:text="${u.enabled ? 'Active' : 'Locked'}">Active</span></td>

                        <td>
                            <div class="d-flex flex-column gap-2" style="min-width: 100px;">
                                <button type="submit"
                                        class="btn btn-sm btn-success"
                                        style="background-color: #6cbf6f; color: white; border: none;">
                                    <i class="fas fa-save me-1"></i> L∆∞u
                                </button>
                                </form> <a th:href="@{'/user/admin/users/delete/' + ${u.id}}"
                                           class="btn btn-sm btn-danger"
                                           style="background-color: #ff8787; color: white; border: none;"
                                           onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?');">
                                <i class="fas fa-trash me-1"></i> X√≥a
                            </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>
<!--Qu·∫£n l√Ω s·∫£n ph·∫©m ADMIN-->
        <section id="admin-products" class="tab-section" style="display:none" th:if="${session.loggedInUser.role == 'ADMIN'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Qu·∫£n l√Ω S·∫£n ph·∫©m</h3>
                <button type="button" class="btn btn-danger" onclick="openAddProductModal('/admin/products/add')" style="background-color: #02ab4b; color: white; border: none; max-width: 200px;">
                    <i class="fa-solid fa-plus me-2"></i>Th√™m s·∫£n ph·∫©m
                </button>
            </div>

            <form th:action="@{/user/profile}" method="get" class="mb-4">
                <input type="hidden" name="tab" value="admin-products"/>
                <div class="row g-3 align-items-center">
                    <div class="col-md-5">
                        <input type="text"
                               name="keyword"
                               class="form-control"
                               placeholder="T√¨m theo T√™n ho·∫∑c T√°c gi·∫£..."
                               th:value="${currentKeyword}" />
                    </div>
                    <div class="col-md-4">
                        <select name="category" class="form-select">
                            <option value="">-- T·∫•t c·∫£ Th·ªÉ lo·∫°i --</option>
                            <option th:each="cat : ${categories}"
                                    th:value="${cat.name}"
                                    th:selected="${cat.name == currentCategory}"
                                    th:text="${cat.name}"></option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex gap-2">
                        <button type="submit"
                                class="btn btn-primary w-100"
                                style="background-color: #e36bb3; color: white; border: none;">
                            <i class="fa-solid fa-search me-1"></i> T√¨m ki·∫øm
                        </button>
                        <a th:href="@{/user/profile(tab='admin-products')}"
                           class="btn btn-outline-secondary"
                           style="background-color: #e36bb3; color: white; border: none;">
                           Reset t√¨m ki·∫øm
                            <i class="fa-solid fa-rotate-left"></i>
                        </a>
                    </div>
                    <div th:if="${errorMsg}" class="alert alert-danger text-center">
                        [[${errorMsg}]]
                    </div>
                    <div th:if="${totalProductsCount != null}" class="text-end">
                        <span class="text-muted small" style="color: #012121 !important;">
                            Hi·ªÉn th·ªã:
                            <strong th:text="${totalProductsCount}">0</strong>
                            s·∫£n ph·∫©m
                        </span>
                    </div>
                </div>
            </form>

            <div th:replace="fragments/admin-product-list :: productList(${allProducts})">
            </div>
        </section>
<!--Qu·∫£n l√Ω th·ªÉ lo·∫°i ADMIN-->
        <section id="admin-categories" class="tab-section" style="display:none" th:if="${session.loggedInUser.role == 'ADMIN'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Qu·∫£n l√Ω Th·ªÉ lo·∫°i</h3>
                <button type="button" class="btn btn-danger" onclick="openAddCategoryModal()" style="background-color: #02ab4b; color: white; border: none; max-width: 200px;">
                    <i class="fa-solid fa-plus me-2"></i>Th√™m Th·ªÉ lo·∫°i
                </button>
            </div>

            <div th:replace="fragments/admin-categories :: categoryList(${categories})">
            </div>
        </section>
<!--Qu·∫£n l√Ω ƒë∆°n h√†ng ADMIN-->
        <section id="admin-orders" class="tab-section" style="display:none" th:if="${session.loggedInUser.role == 'ADMIN'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Qu·∫£n l√Ω ƒê∆°n h√†ng</h3>
            </div>
            <div th:replace="fragments/admin-order-list :: adminOrderList(allOrders=${allOrders})"></div>
        </section>

        <div id="addProductModalContainer"></div>

        <div id="editProductModalContainer"></div>

        <div id="editOrderModalContainer"></div>

    </main>
</div>

<footer class="site-footer">
    ¬© 2025 Bookly ‚Äî All rights reserved
</footer>
<script th:src="@{/js/shop.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script th:inline="javascript">
    // =============================
    // üß≠ CHUY·ªÇN TAB TRONG SIDEBAR
    // =============================
    function switchTab(event) {
        event.preventDefault();
        const el = event.currentTarget;
        document.querySelectorAll('.nav-link-dashboard').forEach(a => a.classList.remove('active'));
        el.classList.add('active');
        const target = el.dataset.target;
        document.querySelectorAll('.tab-section').forEach(s => s.style.display = 'none');
        const section = document.getElementById(target);
        if (section) section.style.display = 'block';
        else document.getElementById('profile').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // =============================
    // ‚ö° KH√îI PH·ª§C TAB KHI RELOAD (d·ª±a v√†o model.activeTab)
    // =============================
    (function restoreActiveTab(){
        const activeTab = /*[[${activeTab}]]*/ '';
        if(activeTab){
            const link = document.querySelector(`.nav-link-dashboard[data-target="${activeTab}"]`);
            if(link){
                // B·ªè tr·∫°ng th√°i active c≈©
                document.querySelectorAll('.nav-link-dashboard').forEach(a => a.classList.remove('active'));
                link.classList.add('active');

                // ·∫®n t·∫•t c·∫£ section r·ªìi hi·ªÉn th·ªã tab ƒë√∫ng
                document.querySelectorAll('.tab-section').forEach(s => s.style.display = 'none');
                const section = document.getElementById(activeTab);
                if(section) section.style.display = 'block';
                window.scrollTo({top:0});
                return; // ‚úÖ Ng·ª´ng t·∫°i ƒë√¢y, tr√°nh initDefault ch·∫°y l·∫°i
            }
        }
        // N·∫øu kh√¥ng c√≥ tab ƒë∆∞·ª£c set ‚Üí hi·ªÉn th·ªã tab m·∫∑c ƒë·ªãnh
        initDefault();
    })();

    // =============================
    // üß© HI·ªÇN TH·ªä TAB M·∫∂C ƒê·ªäNH
    // =============================
    function initDefault(){
        const first = document.querySelector('.nav-link-dashboard.active');
        if(first){
            const tgt = first.dataset.target;
            document.querySelectorAll('.tab-section').forEach(s=>s.style.display='none');
            document.getElementById(tgt).style.display='block';
        } else {
            document.getElementById('profile').style.display='block';
        }
    }

<!--ƒê∆°n h√†ng-->
    // =============================
    // üì¶ TOGGLE CHI TI·∫æT ƒê∆†N H√ÄNG
    // =============================
    function toggleOrderDetails(btn){
        const card = btn.closest('.card');
        if(!card) return;
        const details = card.querySelector('.order-details');
        if(!details) return;
        details.style.display = details.style.display === 'block' ? 'none' : 'block';
    }

    // =============================
    // ‚≠ê ADMIN: C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI (AJAX - KH√îNG RELOAD) ‚≠ê
    // =============================
    function updateOrderStatusAjax(button) {
        const row = button.closest('.status-control');
        const orderId = row.getAttribute('data-order-id');
        const select = row.querySelector('select');
        const newStatus = select.value;
        const currentStatusText = select.options[select.selectedIndex].text; // L·∫•y text (v√≠ d·ª•: ƒêang Giao)

        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thay ƒë·ªïi tr·∫°ng th√°i ƒêH #${orderId} th√†nh "${currentStatusText}"?`)) {
            return;
        }

        const url = `/orders/api/update-status/${orderId}?status=${newStatus}`;

        fetch(url, { method: 'POST' })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i.'); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // C·∫≠p nh·∫≠t l·∫°i badge tr·∫°ng th√°i trong h√†ng ch√≠nh
                    const statusBadgeElement = document.querySelector(`#order-main-${orderId} td:nth-child(6) span.badge`);

                    if (statusBadgeElement) {
                        statusBadgeElement.textContent = currentStatusText;
                        // C·∫≠p nh·∫≠t m√†u s·∫Øc (N·∫øu admin-order-list s·ª≠ d·ª•ng badge m√†u s·∫Øc)
                        statusBadgeElement.className = 'badge'; // Reset classes
                        statusBadgeElement.classList.add(getStatusClass(newStatus));
                    }

                    // C·∫≠p nh·∫≠t l·∫°i gi√° tr·ªã trong select box
                    select.value = newStatus;

                    alert(`Tr·∫°ng th√°i ƒêH #${orderId} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!`);
                }
            })
            .catch(error => {
                alert(`L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i: ${error.message}`);
                // Gi·ªØ l·∫°i gi√° tr·ªã c≈© n·∫øu th·∫•t b·∫°i (T√πy ch·ªçn)
                // select.value = originalStatus;
            });
    }

    // ‚≠ê H√ÄM GET STATUS CLASS (ƒê·ªÉ c·∫≠p nh·∫≠t m√†u s·∫Øc badge)
    function getStatusClass(status) {
        if (status === 'DA_HUY') return 'bg-danger';
        if (status === 'DA_GIAO') return 'bg-success';
        if (status === 'DA_NHAN') return 'bg-dark';
        if (status === 'DANG_GIAO') return 'bg-warning text-dark';
        return 'bg-primary'; // CHUA_NHAN
    }


    // =============================
    // ‚≠ê LOGIC S·ª¨A ƒê∆†N H√ÄNG (AJAX Modal) ‚≠ê
    // =============================

    // ‚≠ê LOGIC CLIENT-SIDE TƒÇNG/GI·∫¢M S·ªê L∆Ø·ª¢NG (T·ª´ edit-order-form.html)
    function updateEditQty(button, delta) {
        const input = button.closest('.input-group').querySelector('.edit-qty-input');
        if (!input) return;

        let val = parseInt(input.value || '0', 10);
        // L·∫•y gi·ªõi h·∫°n MAX t·ª´ thu·ªôc t√≠nh 'max' c·ªßa input (ƒê√£ l√† t·ªìn kho th·ª±c t·∫ø)
        const maxQty = parseInt(input.getAttribute('max'), 10);
        let newVal = val + delta;

        if (newVal < 1) {
            newVal = 1;
        } else if (newVal > maxQty) {
            alert("S·ªë l∆∞·ª£ng s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° t·ªìn kho hi·ªán c√≥: " + maxQty);
            newVal = maxQty;
        }

        input.value = newVal;
    }

    // ‚≠ê LOGIC X√ìA S·∫¢N PH·∫®M KH·ªéI FORM (X√≥a h√†ng DOM)
    function removeOrderItem(button) {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi ƒë∆°n h√†ng?')) {
            const row = button.closest('.product-item-row');
            if (row) {
                row.remove();
            }
        }
    }

    // ‚≠ê LOGIC VALIDATE TR∆Ø·ªöC KHI SUBMIT (Client-side check)
    function validateEditForm() {
        const productRows = document.querySelectorAll('#editOrderModal .product-item-row');
        if (productRows.length === 0) {
            alert('ƒê∆°n h√†ng kh√¥ng ƒë∆∞·ª£c tr·ªëng. Vui l√≤ng gi·ªØ l·∫°i √≠t nh·∫•t 1 s·∫£n ph·∫©m ho·∫∑c h·ªßy ƒë∆°n h√†ng.');
            return false;
        }

        let isValid = true;
        productRows.forEach(row => {
            const input = row.querySelector('.edit-qty-input');
            const maxQty = parseInt(input.getAttribute('max'), 10);
            const qty = parseInt(input.value, 10);

            if (qty < 1 || qty > maxQty) {
                alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá cho s·∫£n ph·∫©m ' + row.querySelector('strong').textContent + '. Vui l√≤ng ki·ªÉm tra t·ªìn kho.');
                isValid = false;
            }
        });

        return isValid;
    }

    // =============================
    // üõ†Ô∏è M·ªû MODAL CH·ªàNH S·ª¨A ƒê∆†N H√ÄNG (D√ôNG AJAX)
    // =============================
    function openEditOrderModal(orderId){
        // ‚≠ê Container Modal: ƒê·∫£m b·∫£o div n√†y t·ªìn t·∫°i trong user.html
        const modalContainer = document.getElementById('editOrderModalContainer');
        if (!modalContainer) return alert('L·ªói: Kh√¥ng t√¨m th·∫•y container modal.');

        // 1. G·ª≠i y√™u c·∫ßu AJAX ƒë·ªÉ l·∫•y form ch·ªânh s·ª≠a
        fetch(`/orders/edit-form/${orderId}`)
            .then(response => {
                if (!response.ok) {
                    // N·∫øu Controller tr·∫£ v·ªÅ l·ªói (v√≠ d·ª•: 403 Forbidden n·∫øu tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá)
                    return response.text().then(text => {
                        // C·ªë g·∫Øng b·∫Øt th√¥ng b√°o l·ªói c·ª• th·ªÉ t·ª´ RuntimeException (n·∫øu c√≥)
                        let errorMessage = 'Kh√¥ng th·ªÉ t·∫£i form s·ª≠a ƒë∆°n h√†ng.';

                        // ƒê√¢y l√† m·ªôt c√°ch ƒë∆°n gi·∫£n ƒë·ªÉ ƒëo√°n l·ªói t·ª´ response
                        if (text.includes("Ch·ªâ c√≥ th·ªÉ s·ª≠a ƒë∆°n h√†ng")) {
                            errorMessage = "ƒê∆°n h√†ng n√†y kh√¥ng th·ªÉ s·ª≠a ƒë∆∞·ª£c. Ch·ªâ cho ph√©p s·ª≠a khi tr·∫°ng th√°i l√† Ch·ªù x√°c nh·∫≠n.";
                        } else if (text.includes("B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a ƒë∆°n h√†ng")) {
                            errorMessage = "L·ªói b·∫£o m·∫≠t: B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a ƒë∆°n h√†ng n√†y.";
                        }
                        throw new Error(errorMessage);
                    });
                }
                return response.text();
            })
            .then(html => {
                // 2. Ch√®n n·ªôi dung form v√†o container
                modalContainer.innerHTML = html;

                // 3. T√¨m ph·∫ßn t·ª≠ Modal th·ª±c s·ª± (c√≥ ID l√† #editOrderModal)
                const actualModal = modalContainer.querySelector('#editOrderModal');

                if (actualModal) {
                    // 4. Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng Modal Bootstrap v√† hi·ªÉn th·ªã
                    const modalElement = new bootstrap.Modal(actualModal);
                    modalElement.show();

                    // 5. D·ªçn d·∫πp container sau khi modal ƒë√≥ng
                    actualModal.addEventListener('hidden.bs.modal', function () {
                        modalContainer.innerHTML = '';
                    });
                } else {
                    throw new Error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ modal trong n·ªôi dung t·∫£i v·ªÅ.");
                }
            })
            .catch(error => {
                console.error('L·ªói AJAX khi t·∫£i form s·ª≠a ƒë∆°n h√†ng:', error);
                // Hi·ªÉn th·ªã l·ªói ra alert
                alert(error.message);
            });
    }

<!--Qu·∫£n l√Ω gi·ªè h√†ng-->
 // ====================================================================
// üßÆ C·∫¨P NH·∫¨T S·ªê L∆Ø·ª¢NG GI·ªé H√ÄNG (S·ª≠ d·ª•ng AJAX - KH√îNG RELOAD)
// ====================================================================
function changeQty(button, delta){
    const qtyGroup = button.closest('[data-item-id]');
    if(!qtyGroup) return;

    const input = qtyGroup.querySelector('.qty-input');
    let val = parseInt(input.value || '0', 10);
    const maxQty = parseInt(input.getAttribute('data-max-qty'), 10);
    const itemId = qtyGroup.getAttribute('data-item-id');

    let newVal = Math.max(1, val + delta);

    if (newVal > maxQty) {
        alert("S·ªë l∆∞·ª£ng s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng t·ªëi ƒëa c√≥ th·ªÉ mua: " + maxQty);
        newVal = maxQty;
    }

    if (newVal === val || newVal < 1) return;

    const oldVal = val;
    input.value = newVal;

    const updateUrl = `/cart/api/update/${itemId}`;
    const formData = new URLSearchParams();
    formData.append('quantity', newVal);

    fetch(updateUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'L·ªói c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng.');
            });
        }
    })
    .then(data => {
        if(data.success) {
            const formattedNewSubtotal = new Intl.NumberFormat('vi-VN').format(data.newSubtotal) + ' ƒë';
            const row = qtyGroup.closest('.d-flex.gap-3');

            // 1. C·∫≠p nh·∫≠t Subtotal c·ªßa Cart Item
            const subtotalEl = row.querySelector('.fw-bold.fs-5.text-primary');
            if(subtotalEl) {
                subtotalEl.textContent = formattedNewSubtotal;
                console.log('‚úÖ C·∫≠p nh·∫≠t subtotal:', formattedNewSubtotal);
            }

            // 2. C·∫≠p nh·∫≠t T·ªïng ti·ªÅn to√†n b·ªô gi·ªè h√†ng
            const totalEl = document.getElementById('totalAmount');
            if(totalEl) {
                const formattedTotal = new Intl.NumberFormat('vi-VN').format(data.totalCart) + ' ƒë';
                totalEl.textContent = formattedTotal;
                console.log('‚úÖ C·∫≠p nh·∫≠t t·ªïng ti·ªÅn:', formattedTotal);
            } else {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y element #totalAmount');
            }

            console.log('‚úÖ C·∫≠p nh·∫≠t gi·ªè h√†ng th√†nh c√¥ng!');
        }
    })
    .catch(error => {
        console.error('‚ùå AJAX Error:', error);
        input.value = oldVal;
        alert(error.message);
    });
}

// =============================
// ‚ùå LOGIC X√ÅC NH·∫¨N KHI X√ìA
// =============================
document.addEventListener('DOMContentLoaded', () => {
    document.body.addEventListener('click', function(e) {
        const deleteButton = e.target.closest('a.btn-outline-danger');

        if (deleteButton && deleteButton.getAttribute('href').includes('/cart/remove/')) {
            e.preventDefault();

            const row = deleteButton.closest('.d-flex.gap-3');
            const productName = row ? row.querySelector('h6').textContent : 's·∫£n ph·∫©m n√†y';

            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m \"" + productName + "\" kh·ªèi gi·ªè h√†ng?")) {
                window.location.href = deleteButton.getAttribute('href');
            }
        }
    });

    // Ki·ªÉm tra xem element totalAmount c√≥ t·ªìn t·∫°i kh√¥ng
    const totalEl = document.getElementById('totalAmount');
    if(totalEl) {
        console.log('‚úÖ Element #totalAmount ƒë√£ s·∫µn s√†ng');
    } else {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y element #totalAmount khi t·∫£i trang');
    }
});

// =============================
// üí≥ THANH TO√ÅN CHECKOUT
// =============================
function openCheckoutModal(){
    const items = document.querySelectorAll('input[name="itemIds"]');

    if(items.length === 0){
        alert('Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.');
        return;
    }

    const method = confirm('Ch·ªçn OK ƒë·ªÉ "KHI_GIAO_H√ÄNG", H·ªßy ƒë·ªÉ "CHUY·ªÇN_KHO·∫¢N"') ? 'KHI_GIAO_HANG' : 'CHUYEN_KHOAN';
    document.getElementById('checkoutPaymentMethod').value = method;

    document.getElementById('checkoutForm').submit();
}

<!--T·ªïng quan ADMIN-->
    // =============================
    // üìä BI·ªÇU ƒê·ªí DOANH THU ADMIN
    // =============================
    (function drawAdminChart(){
        const ctx = document.getElementById('adminRevenueChart');
        if(!ctx) return;
        let monthly = [];
        try {
            monthly = /*[[${monthlyRevenue}]]*/ [];
            if (!Array.isArray(monthly)) monthly = [];
        } catch(e){
            monthly = [];
        }
        const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const values = (typeof monthly !== 'undefined' && monthly.length>0) ? monthly : [0,0,0,0,0,0,0,0,0,0,0,0];
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: values,
                    fill: true,
                    tension: 0.3,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    })();

<!--Qu·∫£n l√Ω s·∫£n ph·∫©m ADMIN-->
    // =============================
    // ‚ûï M·ªû MODAL TH√äM CATEGORY (M·ªõi)
    // =============================
    function openAddCategoryModal() {
        const modalContainer = document.getElementById('addProductModalContainer'); // T√°i s·ª≠ d·ª•ng container ho·∫∑c t·∫°o m·ªõi
        fetch('/admin/categories/add-form') // Endpoint m·ªõi
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                modalContainer.innerHTML = html;
                const actualModal = modalContainer.querySelector('.modal');
                if (actualModal) {
                    const modalElement = new bootstrap.Modal(actualModal);
                    modalElement.show();
                } else {
                    console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ .modal trong n·ªôi dung t·∫£i v·ªÅ.");
                }
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i form th√™m th·ªÉ lo·∫°i:", error);
                alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i form th√™m th·ªÉ lo·∫°i. Vui l√≤ng ki·ªÉm tra console.");
            });
    }

    // =============================
    // ‚úèÔ∏è M·ªû MODAL CH·ªàNH S·ª¨A CATEGORY
    // =============================
    function openEditCategoryModal(editUrl) {
        const modalContainer = document.getElementById('addProductModalContainer'); // T√°i s·ª≠ d·ª•ng container
        fetch(editUrl)
            .then(response => response.text())
            .then(html => {
                modalContainer.innerHTML = html;
                const actualModal = modalContainer.querySelector('.modal');
                if (actualModal) {
                    const modalElement = new bootstrap.Modal(actualModal);
                    modalElement.show();
                } else {
                    console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ .modal trong n·ªôi dung t·∫£i v·ªÅ.");
                }
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i form s·ª≠a th·ªÉ lo·∫°i:", error);
            });
    }

    // =============================
    // ‚ûï M·ªû MODAL TH√äM S·∫¢N PH·∫®M
    // =============================
    function openAddProductModal(addUrl) {
        const modalContainer = document.getElementById('addProductModalContainer');
        if (!modalContainer) {
            console.error('Kh√¥ng t√¨m th·∫•y #addProductModalContainer');
            return;
        }
        fetch(addUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                modalContainer.innerHTML = html;
                const actualModal = modalContainer.querySelector('.modal');

                if (actualModal) {
                    const modalElement = new bootstrap.Modal(actualModal);
                    modalElement.show();
                } else {
                    console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ .modal trong n·ªôi dung t·∫£i v·ªÅ.");
                }
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i form th√™m s·∫£n ph·∫©m:", error);
                alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i form th√™m s·∫£n ph·∫©m. Vui l√≤ng ki·ªÉm tra console.");
            });
    }

    // =============================
    // üîó G·∫ÆN S·ª∞ KI·ªÜN CLICK CHO N√öT S·ª¨A (trong admin-product-list)
    // =============================
    document.addEventListener('DOMContentLoaded', () => {
        // T√¨m section qu·∫£n l√Ω s·∫£n ph·∫©m
        const adminProductsSection = document.getElementById('admin-products');
        if (adminProductsSection) {
            // G·∫Øn s·ª± ki·ªán l·∫Øng nghe cho to√†n b·ªô section ƒë·ªÉ b·∫Øt c√°c n√∫t 'S·ª≠a' (delegate event)
            adminProductsSection.addEventListener('click', (e) => {
                // Ki·ªÉm tra xem ph·∫ßn t·ª≠ ƒë∆∞·ª£c click c√≥ ph·∫£i l√† n√∫t 'S·ª≠a' (btn-outline-primary) kh√¥ng
                const editButton = e.target.closest('a.btn-outline-primary');

                // Ki·ªÉm tra xem n√∫t 'S·ª≠a' c√≥ t·ªìn t·∫°i v√† text l√† 'S·ª≠a' (ƒë·ªÉ lo·∫°i tr·ª´ n√∫t kh√°c)
                if (editButton && editButton.textContent.trim() === 'S·ª≠a') {
                    e.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi chuy·ªÉn trang m·∫∑c ƒë·ªãnh
                    const editUrl = editButton.getAttribute('href');
                    openEditProductModal(editUrl);
                }
            });
        }
    });

    // =============================
    // ‚úèÔ∏è M·ªû MODAL CH·ªàNH S·ª¨A S·∫¢N PH·∫®M
    // =============================
    function openEditProductModal(editUrl) {
        // 1. L·∫•y container modal
        const modalContainer = document.getElementById('editProductModalContainer');
        if (!modalContainer) {
            console.error('Kh√¥ng t√¨m th·∫•y #editProductModalContainer');
            return;
        }
        // 2. T·∫£i n·ªôi dung form t·ª´ server
        fetch(editUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                // 3. Ch√®n n·ªôi dung form ƒë√£ load v√†o Modal Container
                modalContainer.innerHTML = html;

                // 4. T√¨m ph·∫ßn t·ª≠ Modal th·ª±c s·ª± (l√† ph·∫ßn t·ª≠ con ƒë·∫ßu ti√™n ƒë∆∞·ª£c ch√®n, ph·∫£i c√≥ class .modal)
                const actualModal = modalContainer.querySelector('.modal');

                if (actualModal) {
                    // 5. Kh·ªüi t·∫°o ƒë·ªëi t∆∞·ª£ng Modal Bootstrap v√† g·ªçi show
                    const modalElement = new bootstrap.Modal(actualModal);
                    modalElement.show();
                } else {
                    console.error("L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ .modal trong n·ªôi dung t·∫£i v·ªÅ.");
                }
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i form ch·ªânh s·ª≠a:", error);
                alert("L·ªói: Kh√¥ng th·ªÉ t·∫£i form ch·ªânh s·ª≠a s·∫£n ph·∫©m. Vui l√≤ng ki·ªÉm tra console.");
            });
    }
</script>

</body>
</html>